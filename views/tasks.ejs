<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head') %>
  <title>Task Board</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet">
</head>
<body class="dark-theme">
  <%- include('partials/navbar') %>

  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="fw-bold text-gradient">Task Board</h2>
      <button class="btn btn-outline-light" id="themeToggle">🌓</button>
    </div>

    <!-- Create Task Card -->
    <div class="card glass-card mb-4 p-4">
      <h5 class="mb-3">Create New Task</h5>
      <form action="/tasks" method="POST" class="row g-2">
        <div class="col-md-3">
          <input type="text" name="title" placeholder="Task Title" class="form-control" required>
        </div>
        <div class="col-md-4">
          <input type="text" name="description" placeholder="Description" class="form-control">
        </div>
        <div class="col-md-3">
          <input type="date" name="dueDate" class="form-control" id="dueDate" required>
          <div class="invalid-feedback">⚠️ Please select a valid future date.</div>
        </div>
        <% if (user.role === 'admin') { %>
        <div class="col-md-2">
          <select name="assignedTo" class="form-select">
            <% employees.forEach(emp => { %>
              <option value="<%= emp._id %>"><%= emp.name %></option>
            <% }) %>
          </select>
        </div>
        <% } %>
        <div class="col-12 mt-2">
          <button class="btn btn-primary w-100">Add Task</button>
        </div>
      </form>
    </div>

    <!-- Tasks Section -->
    <div class="row" id="taskContainer">
      <% tasks.forEach(task => { %>
        <div class="col-md-4 mb-4">
          <div class="card glass-card p-3 shadow-sm task-card">
            <h5><%= task.title %></h5>
            <p class=" small"><%= task.description || 'No description' %></p>
            <p><b>Status:</b> <span class="badge bg-info"><%= task.status %></span></p>
            <p><b>Due:</b> <%= task.dueDate ? task.dueDate.toISOString().split('T')[0] : 'No date' %></p>
            <% if (task.assignedTo) { %>
              <p><b>Assigned To:</b> <%= task.assignedTo.name %></p>
            <% } %>

            <select class="form-select form-select-sm mb-2 statusSelect" data-id="<%= task._id %>">
              <option <%= task.status==='Pending'?'selected':'' %>>Pending</option>
              <option <%= task.status==='In Progress'?'selected':'' %>>In Progress</option>
              <option <%= task.status==='Completed'?'selected':'' %>>Completed</option>
            </select>
            <div class="d-flex justify-content-between">
              <button class="btn btn-sm btn-outline-success saveStatus" data-id="<%= task._id %>">Save</button>
              <button class="btn btn-sm btn-outline-danger deleteTask" data-id="<%= task._id %>">🗑️</button>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastMsg" class="toast text-bg-success border-0">
      <div class="d-flex">
        <div class="toast-body"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/tasks.js"></script>
</body>
<script>
  const dueDateInput = document.getElementById("dueDate");
  const submitBtn = document.querySelector("button[type='submit']");
  const today = new Date().toISOString().split("T")[0];

  // Set the minimum date to today
  dueDateInput.setAttribute("min", today);

  // Real-time validation when the user changes or types a date
  dueDateInput.addEventListener("input", () => {
    const selectedDate = dueDateInput.value;
    if (selectedDate && selectedDate < today) {
      dueDateInput.classList.add("is-invalid");
      submitBtn.disabled = true; // disable submit
    } else {
      dueDateInput.classList.remove("is-invalid");
      submitBtn.disabled = false; // enable submit
    }
  });
</script>

</html>
